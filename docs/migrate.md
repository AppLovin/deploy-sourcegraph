# Migrating from previous Data Center configuration

Prior to the existence of this repository, Data Center Kubernetes configuration was generated by the
`sourcegraph-server-gen` binary from a `config.json` file. Existing clusters should be migrated to
use the new Helm chart. Follow these steps:

- Note the currently deployed Sourcegraph Data Center version (`sourcegraph-server-gen version`
  using the version of `sourcegraph-server-gen` that was last used to deploy the cluster).
- Run `sourcegraph-server-gen update` to upgrade to the latest version of the binary.
- Run `sourcegraph-server-gen migrate config.json .` Observe that this creates two new files:
  `values.yaml` and `helm.sh`.
- Run `./helm.sh diff upgrade sourcegraph
  https://github.com/sourcegraph/deploy-sourcegraph/archive/latest.tar.gz | less -R` and observe the
  diff.
- If everything looks good in the diff, run `./helm.sh upgrade sourcegraph
  https://github.com/sourcegraph/deploy-sourcegraph/archive/latest.tar.gz`
- Use `kubectl get pods` to check the health of the cluster. If something goes wrong, you can run
  `sourcegraph-server-gen update $PREVIOUS_VERSION` to revert to the previous version of the
  generator binary and then apply the previous configuration using the normal process with
  `sourcegraph-server-gen`.

Note: the `file!` and `exec!` syntax from `config.json` has been retired. File contents can still be
embedded using the `helm --set` flag (automatically included in `helm.sh`).
