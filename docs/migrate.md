# Migrating from previous Data Center configuration

Prior to the existence of this repository, Data Center Kubernetes configuration was generated by the
`sourcegraph-server-gen` binary from a `config.json` file. Existing clusters should be migrated to
use the new pure Helm chart.

## Pre-requisites

Ensure you have Helm 2.9.1 or later installed.

## Migration

1. Upgrade to Sourcegraph Data Center 2.8.9 using the legacy process:
   ```bash
   sourcegraph-server-gen update 2.8.9
   sourcegraph-server-gen config.json ./helm-chart
   helm upgrade sourcegraph ./helm-chart
   ```

   After upgrade, verify the Sourcegraph cluster is healthy before proceeding to the next step.

1. Migrate `config.json` to the new `values.yaml` config file:
   ```bash
   sourcegraph-server-gen migrate config.json .
   ```

   Observe that this creates two new files: `values.yaml` and `helm.sh`. The latter is just a
   wrapper around `helm` that includes values that were embedded with the `file!` and `exec!`
   syntax.

1. View the diff associated with updating from the pure Helm chart:
   ```bash
   helm plugin install https://github.com/databus23/helm-diff
   ./helm.sh diff upgrade sourcegraph https://github.com/sourcegraph/deploy-sourcegraph/archive/v2.8.9.tar.gz | less -R
   ```
   Scan the diff for unexpected changes. If you notice unexpected changes, email us with the unexpected diff. The following changes are *expected*:
   - If you do **NOT** have the `gitserverSSH` config field set, some deployments drop the
     unnecessary `gitserver-ssh` secret:

     ```diff
     -       - name: ssh
     -         secret:
     -           defaultMode: 384
     -           secretName: gitserver-ssh
     ```

   - If you do **NOT** have the `tlsKey` or `tlsCert` config fields set, the unnecessary `tls` Secret is removed.

   - `indexed-search` deployment adds `ZOEKT_DELETE_REPOS_MIGRATION`:
     ```diff
     +         env:
     +         - name: ZOEKT_DELETE_REPOS_MIGRATION
     +           value: t
     ```
   - `CONFIG_FILE_HASH` changes:
     ```diff
               env:
     -         - name: CONFIG_FILE_HASH
     -           value: 73e94ff25f265a57b3dc8e51260fa5a51bb2942efe1e988858324432e7635c71
     +         - name: CONFIG_FILE_HASH
     +           value: 5d8a54fc10b4b144e580c2a9dfa23fa71b7da7dcfb5250572c9491e1a58ef50c
     ```
   - Resource limits now use explicit strings:
     ```diff
               resources:
                 limits:
                   cpu: "4"
     -             memory: 8Gi
     +             memory: "8Gi"
                 requests:
     -             cpu: 500m
     -             memory: 2Gi
     +             cpu: "500m"
     +             memory: "2Gi"
     ```
   - If Java is enabled, `xlang-java` and `xlang-java-bg` drop empty environment variables:
     ```diff
     +           value: -Xms8000m -Xmx8000m -XX:+PrintFlagsFinal -Dsun.zip.disableMemoryMapping=true -agentlib:jdwp=transport=dt_socket,address=127.0.0.1:8001,suspend=n,server=y
               - name: LS_OPT
                 value: -l INFO
     -         - name: EXECUTE_GRADLE_ORIGINAL_ROOT_PATHS
     -         - name: PRIVATE_ARTIFACT_REPO_ID
     -         - name: PRIVATE_ARTIFACT_REPO_URL
     -         - name: PRIVATE_ARTIFACT_REPO_USERNAME
     -         - name: PRIVATE_ARTIFACT_REPO_PASSWORD
     ```
   - The `config-file` ConfigMap drops the following fields:
     - `deploymentOverrides`
     - `gitserverCount`
     - `gitserverDiskSize`
     - `gitserverSSH`
     - `indexedSearchDiskSize`
     - `storageClass`
   - The ordering of environment variables has changed.
   - The following environment variables have been removed:
     - `PHABRICATOR_CONFIG`
     - `PHABRICATOR_URL`
     - `MAX_REPOS_TO_SEARCH`
     - `SEARCH_SCOPES`, `searchScopes`
   - The `xlang-*-bg` deployments now have the same NodeSelectors as the corresponding `xlang-*` (non-bg) deployments.

1. Update your cluster from the pure Helm chart:
   ```bash
   ./helm.sh upgrade sourcegraph https://github.com/sourcegraph/deploy-sourcegraph/archive/v2.8.9.tar.gz
   ```

1. Use `kubectl get pods` to check the health of the cluster. If something goes wrong, you can revert
   the change by running through the old update process with `sourcegraph-server-gen`.

Note: the `file!` and `exec!` syntax from `config.json` has been retired. File contents can still be
embedded using the `helm --set` flag (automatically included in `helm.sh`).
